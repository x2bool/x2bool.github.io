{"componentChunkName":"component---src-templates-blog-post-js","path":"/mocking-with-source-generators/","result":{"data":{"site":{"siteMetadata":{"title":"Sergei Khabibullin - blog"}},"markdownRemark":{"id":"3651c929-945f-5952-98c1-2a6d3ede7db6","excerpt":"The title of this post emphasizes performance, but in reality, simplicity was my primary focus. From the outset, I knew there was significant potential for…","html":"<h1></h1>\n<p>The title of this post emphasizes performance, but in reality, simplicity was my primary focus. From the outset, I knew there was significant potential for performance improvements; everything just needed to come together smoothly—and for the most part, it did. I understand that being fast isn't the most crucial factor in every aspect of programming. In some cases, \"good enough\" really is good enough. So, if you don't prioritize the performance of your mocking tool, that's perfectly fine. However, performance is measurable and generally objective, while simplicity and ergonomics are highly subjective—hence the title of this article.</p>\n<p>Overall, this post is the result of exploring a \"what if we…\" idea. I found the outcomes of this exploration compelling enough to share them as a blog post.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4f67ee65c10a6cfcac04f88468aebfe8/b4294/mockup-benchmarks.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 78.48101265822784%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAQABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBAgP/xAAUAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAFbJqhcaDH/xAAbEAADAAIDAAAAAAAAAAAAAAABAgMAERIhIv/aAAgBAQABBQJnY4C+g3R4irU2sfMf/8QAFxEAAwEAAAAAAAAAAAAAAAAAABEhEv/aAAgBAwEBPwGOmT//xAAYEQACAwAAAAAAAAAAAAAAAAAAARIhMf/aAAgBAgEBPwG1hI//xAAdEAACAgEFAAAAAAAAAAAAAAAAAQIhERIiMVFh/9oACAEBAAY/ArxXhy8C2MuzTGOCKfR//8QAGhABAAMBAQEAAAAAAAAAAAAAAQARITFhcf/aAAgBAQABPyG/qbfUu0DxH2fO32WKkDe6sVABj21kf//aAAwDAQACAAMAAAAQKM//xAAXEQEBAQEAAAAAAAAAAAAAAAABABEh/9oACAEDAQE/EDQByRf/xAAWEQEBAQAAAAAAAAAAAAAAAAABAHH/2gAIAQIBAT8QUJi//8QAHRABAAICAgMAAAAAAAAAAAAAAQARITFBcVFhkf/aAAgBAQABPxB8oI07FzlzDFAg2rheOp6tIKh51B0KgA3OcEC5+S1iENE//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Excel SQLite\"\n        title=\"\"\n        src=\"/static/4f67ee65c10a6cfcac04f88468aebfe8/b4294/mockup-benchmarks.jpg\"\n        srcset=\"/static/4f67ee65c10a6cfcac04f88468aebfe8/ff44c/mockup-benchmarks.jpg 158w,\n/static/4f67ee65c10a6cfcac04f88468aebfe8/a6688/mockup-benchmarks.jpg 315w,\n/static/4f67ee65c10a6cfcac04f88468aebfe8/b4294/mockup-benchmarks.jpg 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>C# source generators are an incredible tool for certain use cases. The increasing use of ahead-of-time compilation, despite its limitations, is also contributing to the broader adoption of this technology. I believe we have yet to see some great .NET applications and frameworks based on compile-time source code generation, as there seem to be promising opportunities in this area.</p>\n<h3>How would you mock something without using a framework?</h3>\n<p>I imagine everyone with sufficient experience knows what mocking is in the context of testing, so I won’t spend time explaining why and when it is needed. However, I’d like to start with a very basic example of manual mocking because:</p>\n<ol>\n<li>It will illustrate my thought process and motivation for this approach.</li>\n<li>It’s exactly what we’ll implement in the end—basic and simple (but with all the boring parts delegated to the compiler). So, please follow along.</li>\n</ol>\n<p>Let’s mock a simple interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IService</span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>For now, we’ll avoid using any frameworks or libraries and do all the work ourselves. How would you mock it manually? It depends on what exactly is needed. We could simply implement the interface with some hard-coded behavior for the <code class=\"language-text\">GetData</code> method:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HardcodedService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> arg<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">return</span> <span class=\"token string\">\"some data\"</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>That might actually be good enough for some use cases. It’s even possible to write custom logic based on the data passed into the method. But now, let’s consider a situation where this approach becomes difficult to scale.</p>\n<h3>This is getting repetitive</h3>\n<p>Consider an interface with more methods:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IService</span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetSomeOtherData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token comment\">// ... 10 more methods</span>\n   <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetEvenMoreData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Some might say this is a poorly designed interface—10+ methods? Perhaps we’ve violated one or more of the SOLID principles, and maybe we should consider refactoring. Who knows? But in reality, interfaces like this do exist. That’s not the main issue here. The real problem is that the amount of monotonous and boring code we have to write in such cases increases exponentially.</p>\n<p>Even an interface with just 4-5 methods would effectively demonstrate the problem. Imagine mocking this interface for different use cases (let’s say 10+ unit tests, each with slightly different logic):</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FooService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BarService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ... 10 more implementations</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BazService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can already see the problem: a lot of code. We could somewhat reduce the amount of code by adding, say, boolean properties to control how a particular implementation behaves. But there’s a better solution.</p>\n<p>The strategy pattern. The method implementation can be defined outside the method itself by using the strategy pattern. In our particular case, we don’t even need the classic form of this pattern; Functional style and C# delegates (Funcs and Actions) will do the job:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Service</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">public</span> <span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> GetDataImpl<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">GetDataImpl</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> GetSomeOtherDataImpl<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetSomeOtherData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> arg<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">GetSomeOtherDataImpl</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> GetEventMoreDataImpl<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GetEventMoreData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">GetEventMoreDataImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I hope you can see how this allows us to shift the actual implementation from the service class itself to the client code that uses it. Now, we don’t need a separate implementation for each use case—we can control both behavior and state.</p>\n<p>That’s great, but there’s still a chance you don’t want to write that code. If so, you’re not alone, and .NET developers have already solved this problem. However, before we move on, I ask you to take another look at that code—it’s the essence of our future implementation. This example is a bit simplified, and we won’t write it ourselves, but instead, we’ll kindly ask Roslyn to do it for us.</p>\n<h3>Magic to the rescue</h3>\n<p>As mentioned earlier, mocking is a solved problem. Now, let’s take a look at something that already exists and is widely used. The most popular solution is probably Moq (though most other options look quite similar):</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> mock <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Mock<span class=\"token punctuation\">&lt;</span>IService<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmock<span class=\"token punctuation\">.</span><span class=\"token function\">Setup</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span>It<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">IsAny</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">.</span><span class=\"token function\">Returns</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"some data\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> service <span class=\"token operator\">=</span> mock<span class=\"token punctuation\">.</span>Object<span class=\"token punctuation\">;</span>\nservice<span class=\"token punctuation\">.</span><span class=\"token function\">GetData</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"arg\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// -> \"some data\"</span></code></pre></div>\n<p>Despite all the bells and whistles, this approach essentially follows the same idea: generate an implementation and set up state and logic based on the current needs. We provide the rules for a particular use case, and Moq generates the implementation for us at runtime—simple.</p>\n<h3>Shifting the magic to compile time</h3>\n<p>This is where the \"what if we…\" scenario comes into play. What if we shift most of this ceremony to compile time? Will we achieve comparable convenience? Can we improve on it (arguably) and eliminate DSLs such as <code class=\"language-text\">Setup</code>, <code class=\"language-text\">Returns</code>, and other methods? Let’s find out.</p>\n<p>First, we need to decide what we want to generate. The answer is: we want something similar to what we created manually—a class that can be controlled via <code class=\"language-text\">Func</code> delegates. After some quick prototyping, it became clear that separating the mock builder from the actual mock implementation makes sense due to the complexity of resolving method overloads and for the sake of separation of concerns.</p>\n<p>Let’s look at an example of what will be generated for an interface with one read-only property, one write-only property, and a method that takes a <code class=\"language-text\">string</code> and returns a <code class=\"language-text\">string</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceMock</span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">private</span> <span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> _getterOfReadProperty<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">ServiceMock</span> <span class=\"token function\">ReadProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> getter<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       _getterOfReadProperty <span class=\"token operator\">=</span> getter<span class=\"token punctuation\">;</span>\n       <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">private</span> <span class=\"token class-name\">Action<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> _setterOfWriteProperty<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">ServiceMock</span> <span class=\"token function\">WriteProperty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Action<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> setter<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       _setterOfWriteProperty <span class=\"token operator\">=</span> setter<span class=\"token punctuation\">;</span>\n       <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">private</span> <span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> _implOfSingleArgReturnMethod<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">ServiceMock</span> <span class=\"token function\">SingleArgReturnMethod</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Func<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> impl<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       _implOfSingleArgReturnMethod <span class=\"token operator\">=</span> impl<span class=\"token punctuation\">;</span>\n       <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">IService</span> <span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">@<span class=\"token keyword\">class</span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n   <span class=\"token comment\">// ...</span></code></pre></div>\n<p>The job of this generated class is straightforward: define builder methods for each interface method or property and accept a <code class=\"language-text\">Func</code> or <code class=\"language-text\">Action</code> with a signature that matches the target method. Notice how we can generate arbitrary names for the builder methods (which happen to resemble the actual names of the interface methods by design). Unlike traditional frameworks, we are not restricted to working with a predefined builder class that acts as a DSL for constructing implementations at runtime.</p>\n<p>You might have noticed the <code class=\"language-text\">Build</code> method, which we haven't covered yet. As you might guess, it constructs the actual instance of the object. Let’s examine the second important piece of generated code: a class that implements the given interface:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">@<span class=\"token keyword\">class</span></span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IService</span></span>\n<span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">ServiceMock</span> @<span class=\"token keyword\">var</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">public</span> @<span class=\"token keyword\">class</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServiceMock</span> @<span class=\"token keyword\">var</span><span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>@<span class=\"token keyword\">var</span> <span class=\"token operator\">=</span> @<span class=\"token keyword\">var</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> ReadProperty\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">get</span>\n       <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>@<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span>_getterOfReadProperty <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">{</span>\n               <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotImplementedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n           <span class=\"token punctuation\">}</span>\n\n\n           <span class=\"token keyword\">return</span> @<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token function\">_getterOfReadProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> WriteProperty\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">set</span>\n       <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>@<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span>_setterOfWriteProperty <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">{</span>\n               <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotImplementedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n           <span class=\"token punctuation\">}</span>\n\n\n           @<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token function\">_setterOfWriteProperty</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">SingleArgReturnMethod</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> arg<span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">{</span>\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>@<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span>_implOfSingleArgReturnMethod <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotImplementedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n\n\n       <span class=\"token keyword\">return</span> @<span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token function\">_implOfSingleArgReturnMethod</span><span class=\"token punctuation\">(</span>arg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This class is also generated at compile time, and its role is to implement the target interface using the provided delegates. There’s nothing more to say about it, other than that it’s a private nested class inside <code class=\"language-text\">ServiceMock</code>.</p>\n<p>And that’s it—nothing more. This example fully matches what is actually done by the library.</p>\n<h3>A note on inheritance and classes</h3>\n<p>It turns out this model works well with classes and inheritance. Two small additions are needed:</p>\n<ol>\n<li>A class can have multiple constructors, so the generated code must provide corresponding constructors and build methods.</li>\n<li>For virtual methods, if no setup is performed, the generated code must call the base implementation from its parent class by default.</li>\n</ol>\n<h3>Roslyn will do all the work</h3>\n<p>This post is not intended to be a tutorial on writing source generators—there are plenty of those already. However, there is one missing piece we need to discuss: how to specify which interfaces or classes the generator will work on.</p>\n<p>One approach could be to use comments, like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token comment\">// generate mock for IService</span></code></pre></div>\n<p>We could register a syntax receiver to capture comments and parse type names from them to handle the code generation. While this might work in theory, it is not ideal. This method is error-prone and unsafe—any part of the comment could be misspelled, <code class=\"language-text\">IService</code> could be renamed later, and so on. Instead, we will use attributes—an established and reliable way to declare metadata, which is exactly what we need:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">assembly</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Mock</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span><span class=\"token punctuation\">(</span><span class=\"token type-expression class-name\">IService</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token target keyword\">assembly</span><span class=\"token punctuation\">:</span> <span class=\"token class-name\">Mock&lt;IEmptyService></span></span><span class=\"token punctuation\">]</span> <span class=\"token comment\">// for C# version >= 11</span></code></pre></div>\n<p>Now, a syntax receiver is registered to listen for attributes of a given type and extract the necessary metadata at compile time to generate the code described above. Again, this is slightly outside the scope of this post and is a significant topic in itself.</p>\n<h3>Testing</h3>\n<p>Finally, let’s test everything together in a setting that closely resembles the intended use:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Mockup</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Xunit</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// This will generate mock; use Mock(typeof(IService)) for C# &lt; 11.0</span>\n<span class=\"token punctuation\">[</span>assembly<span class=\"token punctuation\">:</span> Mock<span class=\"token operator\">&lt;</span>IService<span class=\"token operator\">></span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">Mockup<span class=\"token punctuation\">.</span>Tests</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ServiceMockTests</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Fact</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">TestReadWriteProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Value\"</span><span class=\"token punctuation\">;</span>\n        \n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceMock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">ReadWriteProperty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">,</span> v <span class=\"token operator\">=></span> <span class=\"token keyword\">value</span> <span class=\"token operator\">=</span> v<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// This will produce IService</span>\n        \n        <span class=\"token comment\">// Your test code...</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span>ReadWriteProperty<span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns \"Value\"</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Fact</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">TestSingleArgReturnMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> service <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceMock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">SingleArgReturnMethod</span><span class=\"token punctuation\">(</span>v <span class=\"token operator\">=></span> <span class=\"token string\">\"Changed\"</span> <span class=\"token operator\">+</span> v<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// This will produce IService</span>\n\n        <span class=\"token comment\">// Your test code...</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> service<span class=\"token punctuation\">.</span><span class=\"token function\">SingleArgReturnMethod</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Value\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// returns \"ChangedValue\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>Benchmarks</h3>\n<p>Let’s create two simple scenarios and compare the results to Moq, NSubstitute, and FakeItEasy. The numbers will speak for themselves.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">BenchmarkDotNet v0.13.12, macOS Ventura 13.6.6 (22G630) [Darwin 22.6.0]\nIntel Core i5-7267U CPU 3.10GHz (Kaby Lake), 1 CPU, 4 logical and 2 physical cores\n.NET SDK 8.0.301 [Host]     : .NET 8.0.6 (8.0.624.26715), X64 RyuJIT AVX2</code></pre></div>\n<p>Return a string hardcoded into a variable:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th align=\"right\">Mean</th>\n<th align=\"right\">Error</th>\n<th align=\"right\">StdDev</th>\n<th align=\"right\">Gen0</th>\n<th align=\"right\">Gen1</th>\n<th align=\"right\">Gen2</th>\n<th align=\"right\">Allocated</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Mockup</td>\n<td align=\"right\">34.60 ns</td>\n<td align=\"right\">0.599 ns</td>\n<td align=\"right\">0.531 ns</td>\n<td align=\"right\">0.0688</td>\n<td align=\"right\">-</td>\n<td align=\"right\">-</td>\n<td align=\"right\">144 B</td>\n</tr>\n<tr>\n<td>Moq</td>\n<td align=\"right\">4,380.75 ns</td>\n<td align=\"right\">58.442 ns</td>\n<td align=\"right\">51.808 ns</td>\n<td align=\"right\">1.8616</td>\n<td align=\"right\">-</td>\n<td align=\"right\">-</td>\n<td align=\"right\">3905 B</td>\n</tr>\n<tr>\n<td>NSubstitute</td>\n<td align=\"right\">5,410.08 ns</td>\n<td align=\"right\">105.646 ns</td>\n<td align=\"right\">121.662 ns</td>\n<td align=\"right\">3.7384</td>\n<td align=\"right\">-</td>\n<td align=\"right\">-</td>\n<td align=\"right\">7833 B</td>\n</tr>\n<tr>\n<td>FakeItEasy</td>\n<td align=\"right\">5,701.07 ns</td>\n<td align=\"right\">107.159 ns</td>\n<td align=\"right\">114.659 ns</td>\n<td align=\"right\">2.4109</td>\n<td align=\"right\">0.0153</td>\n<td align=\"right\">0.0076</td>\n<td align=\"right\">5057 B</td>\n</tr>\n</tbody>\n</table>\n<p>Return a string passed as an argument:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th align=\"right\">Mean</th>\n<th align=\"right\">Error</th>\n<th align=\"right\">StdDev</th>\n<th align=\"right\">Gen0</th>\n<th align=\"right\">Gen1</th>\n<th align=\"right\">Gen2</th>\n<th align=\"right\">Allocated</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Mockup</td>\n<td align=\"right\">16.39 ns</td>\n<td align=\"right\">0.392 ns</td>\n<td align=\"right\">0.347 ns</td>\n<td align=\"right\">0.0268</td>\n<td align=\"right\">-</td>\n<td align=\"right\">-</td>\n<td align=\"right\">56 B</td>\n</tr>\n<tr>\n<td>Moq</td>\n<td align=\"right\">76,471.38 ns</td>\n<td align=\"right\">1,119.135 ns</td>\n<td align=\"right\">934.529 ns</td>\n<td align=\"right\">4.1504</td>\n<td align=\"right\">1.2207</td>\n<td align=\"right\">0.4883</td>\n<td align=\"right\">9118 B</td>\n</tr>\n<tr>\n<td>NSubstitute</td>\n<td align=\"right\">6,309.30 ns</td>\n<td align=\"right\">115.183 ns</td>\n<td align=\"right\">107.743 ns</td>\n<td align=\"right\">3.7537</td>\n<td align=\"right\">-</td>\n<td align=\"right\">-</td>\n<td align=\"right\">7905 B</td>\n</tr>\n<tr>\n<td>FakeItEasy</td>\n<td align=\"right\">6,377.44 ns</td>\n<td align=\"right\">121.293 ns</td>\n<td align=\"right\">129.783 ns</td>\n<td align=\"right\">2.7771</td>\n<td align=\"right\">0.0305</td>\n<td align=\"right\">0.0305</td>\n<td align=\"right\">5861 B</td>\n</tr>\n</tbody>\n</table>\n<p>We need to keep in mind that the frameworks mentioned above are designed to handle much more than what we’ve used here. More features mean more overhead, and everything is done at runtime. Therefore, the comparison may not be entirely fair. Nevertheless, the results are impressive. What’s even more impressive is that the speed is comparable to the hand-coded version; they are essentially the same. We’ve just asked the computer to generate the mock for us.</p>\n<h3>Next steps</h3>\n<p>As I mentioned, this is an experiment, and there are many TODOs: What if we need to mock generic interfaces or classes? What if we need to control the name of the generated mock or even the namespace? There are many more interesting questions to explore. Stay tuned.</p>\n<h3>Links</h3>\n<p>First of all, take a look at the code: <a href=\"https://github.com/x2bool/mockup\">https://github.com/x2bool/mockup</a>. There are also NuGet packages available: <a href=\"https://www.nuget.org/packages/Mockup\">Mockup</a> and <a href=\"https://www.nuget.org/packages/Mockup.Analyzers\">Mockup.Analyzers</a>. Give them a try, and feel free to leave your feedback on GitHub if you have any comments or suggestions.</p>","frontmatter":{"title":"1000x Faster Mocking with C# Source Generators","date":"August 25, 2024","description":"Improving mocking performance with C# Source Generators: a practical approach"}},"previous":{"fields":{"slug":"/sqlite-extensions-in-rust/"},"frontmatter":{"title":"Extending SQLite with Rust to support Excel files as virtual tables"}},"next":null},"pageContext":{"id":"3651c929-945f-5952-98c1-2a6d3ede7db6","previousPostId":"2bb1c8e4-d9ee-58fa-8433-c43c5d6053de","nextPostId":null}},"staticQueryHashes":["2841359383","2958489844"],"slicesMap":{}}